<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kairos - Biblioth√®que de Sources</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c2416">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <script src="theme.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="toast.js"></script>
    <script>
        // Initialize Supabase client (global for auth-menu.js)
        (function() {
            const { url, anonKey, options } = window.KairosConfig.getSupabaseConfig();
            window.supabaseClient = window.supabase.createClient(url, anonKey, options);
        })();
    </script>
    <style>
        .sources-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .sources-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .sources-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .sources-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
        }

        .stat-badge {
            background: var(--bg-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stat-badge strong {
            color: var(--primary-color);
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Category sections */
        .category-section {
            margin-bottom: 2rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg-color);
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .category-header:hover {
            background: var(--border-color);
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-icon {
            font-size: 1.3rem;
        }

        .category-count {
            background: var(--primary-color);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .category-toggle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .category-section.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .category-section.collapsed .sources-grid {
            display: none;
        }

        /* Sources grid */
        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
        }

        .source-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            transition: all 0.2s;
        }

        .source-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .source-info {
            flex: 1;
            min-width: 0;
        }

        .source-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .source-lang {
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            background: #e8f4f8;
            color: #0d6efd;
            font-weight: 500;
        }

        .source-lang.fr {
            background: #fff3e0;
            color: #e65100;
        }

        .source-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .source-url {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .source-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-color);
        }

        .action-btn.favorite {
            color: var(--text-secondary);
        }

        .action-btn.favorite.active {
            color: #ffc107;
            border-color: #ffc107;
        }

        .action-btn.add {
            color: var(--primary-color);
        }

        .action-btn.add:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Add to topic modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .topic-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .topic-option {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .topic-option:hover {
            border-color: var(--primary-color);
            background: var(--bg-color);
        }

        .topic-option.selected {
            border-color: var(--primary-color);
            background: rgba(124, 157, 184, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading-spinner {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        /* Dark mode */
        [data-theme="dark"] .source-lang {
            background: rgba(13, 110, 253, 0.2);
        }

        [data-theme="dark"] .source-lang.fr {
            background: rgba(230, 81, 0, 0.2);
        }

        [data-theme="dark"] .source-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body>
    <header class="header">
        <a href="index.html" class="logo">
            <span>üïê</span> Kairos
        </a>
        <nav class="nav-links">
            <a href="index.html">Accueil</a>
            <a href="sources.html" class="active">Biblioth√®que</a>
            <a href="topic-setup.html">Cr√©er un Topic</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="kanban.html">Kanban</a>
        </nav>
        <div class="header-right">
            <div class="user-menu" id="userMenu"></div>
            <button class="theme-toggle" id="themeToggle" aria-label="Changer de th√®me">
                <svg class="theme-icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                <svg class="theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
        </div>
    </header>

    <div class="container">
        <div class="sources-header">
            <h1>Biblioth√®que de Sources RSS</h1>
            <p>Explorez notre catalogue de sources pour enrichir votre veille</p>
            <div class="sources-stats" id="sourceStats">
                <span class="stat-badge"><strong id="totalCount">-</strong> sources</span>
                <span class="stat-badge"><strong id="frCount">-</strong> FR</span>
                <span class="stat-badge"><strong id="enCount">-</strong> EN</span>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="Rechercher une source...">

            <div class="filter-group">
                <button class="filter-btn active" data-lang="all">Toutes</button>
                <button class="filter-btn" data-lang="fr">FR</button>
                <button class="filter-btn" data-lang="en">EN</button>
            </div>

            <div class="filter-group">
                <button class="filter-btn" data-filter="favorites" id="favoritesFilter">Mes favoris</button>
            </div>
        </div>

        <!-- Sources list -->
        <div id="sourcesList">
            <div class="loading-spinner">Chargement des sources...</div>
        </div>
    </div>

    <!-- Add to Topic Modal -->
    <div class="modal-overlay" id="addToTopicModal">
        <div class="modal">
            <h3>Ajouter √† un topic</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                S√©lectionnez le topic auquel ajouter cette source :
            </p>
            <div class="topic-list" id="topicList">
                <div class="loading-spinner">Chargement...</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" id="confirmAddBtn" onclick="confirmAddToTopic()">Ajouter</button>
            </div>
        </div>
    </div>

    <script src="auth-menu.js"></script>
    <script>
        // Use supabaseClient from window (set in head)
        // Note: 'supabase' is reserved by the CDN, use supabaseClient instead

        // State
        let allSources = [];
        let userFavorites = new Set();
        let userTopics = [];
        let currentFilters = { search: '', lang: 'all', favorites: false };
        let selectedSourceUrl = null;
        let selectedTopicId = null;

        // Category icons and labels
        const categoryInfo = {
            technology: { icon: 'üíª', label: 'Technologie' },
            ai_ml: { icon: 'ü§ñ', label: 'IA & Machine Learning' },
            programming: { icon: 'üë®‚Äçüíª', label: 'Programmation' },
            security: { icon: 'üîí', label: 'S√©curit√©' },
            science: { icon: 'üî¨', label: 'Science' },
            business: { icon: 'üíº', label: 'Business' },
            startup: { icon: 'üöÄ', label: 'Startups' },
            design: { icon: 'üé®', label: 'Design' },
            other: { icon: 'üì∞', label: 'Autres' }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSources();
            await loadUserFavorites();
            setupEventListeners();
        });

        // Load all sources
        async function loadSources() {
            try {
                const { data, error } = await supabaseClient
                    .from('rss_sources')
                    .select('*')
                    .eq('active', true)
                    .order('name');

                if (error) throw error;

                allSources = data || [];
                updateStats();
                renderSources();
            } catch (error) {
                console.error('Error loading sources:', error);
                showToast('Erreur lors du chargement des sources', 'error');
            }
        }

        // Load user favorites
        async function loadUserFavorites() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;

                const { data, error } = await supabaseClient
                    .from('user_favorite_sources')
                    .select('source_id')
                    .eq('user_id', session.user.id);

                if (error) throw error;

                userFavorites = new Set((data || []).map(f => f.source_id));
                renderSources(); // Re-render with favorites
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalCount').textContent = allSources.length;
            document.getElementById('frCount').textContent = allSources.filter(s => s.language === 'fr').length;
            document.getElementById('enCount').textContent = allSources.filter(s => s.language === 'en').length;
        }

        // Filter sources
        function getFilteredSources() {
            return allSources.filter(source => {
                // Search filter
                if (currentFilters.search) {
                    const search = currentFilters.search.toLowerCase();
                    const matchesSearch =
                        source.name.toLowerCase().includes(search) ||
                        (source.description && source.description.toLowerCase().includes(search));
                    if (!matchesSearch) return false;
                }

                // Language filter
                if (currentFilters.lang !== 'all' && source.language !== currentFilters.lang) {
                    return false;
                }

                // Favorites filter
                if (currentFilters.favorites && !userFavorites.has(source.id)) {
                    return false;
                }

                return true;
            });
        }

        // Group sources by category
        function groupByCategory(sources) {
            const groups = {};
            sources.forEach(source => {
                const cat = source.category || 'other';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(source);
            });
            return groups;
        }

        // Render sources
        function renderSources() {
            const container = document.getElementById('sourcesList');
            const filtered = getFilteredSources();
            const grouped = groupByCategory(filtered);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>Aucune source trouv√©e</p>
                    </div>
                `;
                return;
            }

            // Sort categories by count
            const sortedCategories = Object.keys(grouped).sort((a, b) =>
                grouped[b].length - grouped[a].length
            );

            container.innerHTML = sortedCategories.map(category => {
                const sources = grouped[category];
                const info = categoryInfo[category] || categoryInfo.other;

                return `
                    <div class="category-section" data-category="${category}">
                        <div class="category-header" onclick="toggleCategory('${category}')">
                            <div class="category-title">
                                <span class="category-icon">${info.icon}</span>
                                <span>${info.label}</span>
                                <span class="category-count">${sources.length}</span>
                            </div>
                            <span class="category-toggle">‚ñº</span>
                        </div>
                        <div class="sources-grid">
                            ${sources.map(source => renderSourceCard(source)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render single source card
        function renderSourceCard(source) {
            const isFavorite = userFavorites.has(source.id);
            const langClass = source.language === 'fr' ? 'fr' : '';

            return `
                <div class="source-card" data-source-id="${source.id}">
                    <div class="source-info">
                        <div class="source-name">
                            ${source.name}
                            <span class="source-lang ${langClass}">${source.language.toUpperCase()}</span>
                        </div>
                        <div class="source-description">${source.description || ''}</div>
                        <div class="source-url" title="${source.url}">${source.url}</div>
                    </div>
                    <div class="source-actions">
                        <button class="action-btn favorite ${isFavorite ? 'active' : ''}"
                                onclick="toggleFavorite('${source.id}')"
                                title="${isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                            ${isFavorite ? '‚òÖ' : '‚òÜ'}
                        </button>
                        <button class="action-btn add"
                                onclick="openAddToTopic('${source.url}')"
                                title="Ajouter √† un topic">
                            +
                        </button>
                    </div>
                </div>
            `;
        }

        // Toggle category collapse
        function toggleCategory(category) {
            const section = document.querySelector(`.category-section[data-category="${category}"]`);
            section.classList.toggle('collapsed');
        }

        // Toggle favorite
        async function toggleFavorite(sourceId) {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast('Connectez-vous pour ajouter des favoris', 'warning');
                    return;
                }

                const { data, error } = await supabaseClient.rpc('toggle_favorite_source', {
                    p_user_id: session.user.id,
                    p_source_id: sourceId
                });

                if (error) throw error;

                // Update local state
                if (data) {
                    userFavorites.add(sourceId);
                    showToast('Ajout√© aux favoris', 'success');
                } else {
                    userFavorites.delete(sourceId);
                    showToast('Retir√© des favoris', 'success');
                }

                renderSources();
            } catch (error) {
                console.error('Error toggling favorite:', error);
                showToast('Erreur lors de la modification', 'error');
            }
        }

        // Open add to topic modal
        async function openAddToTopic(sourceUrl) {
            selectedSourceUrl = sourceUrl;
            selectedTopicId = null;

            const modal = document.getElementById('addToTopicModal');
            const topicList = document.getElementById('topicList');
            modal.classList.add('visible');

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    topicList.innerHTML = '<p style="color: var(--text-secondary);">Connectez-vous pour ajouter √† un topic</p>';
                    return;
                }

                const { data: topics, error } = await supabaseClient
                    .from('topics')
                    .select('id, name')
                    .eq('user_id', session.user.id)
                    .order('name');

                if (error) throw error;

                userTopics = topics || [];

                if (userTopics.length === 0) {
                    topicList.innerHTML = `
                        <p style="color: var(--text-secondary);">Aucun topic trouv√©.</p>
                        <a href="topic-setup.html" class="btn btn-primary" style="margin-top: 1rem;">Cr√©er un topic</a>
                    `;
                    return;
                }

                topicList.innerHTML = userTopics.map(topic => `
                    <div class="topic-option" data-topic-id="${topic.id}" onclick="selectTopic('${topic.id}')">
                        ${topic.name}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading topics:', error);
                topicList.innerHTML = '<p style="color: var(--text-secondary);">Erreur de chargement</p>';
            }
        }

        // Select topic
        function selectTopic(topicId) {
            selectedTopicId = topicId;
            document.querySelectorAll('.topic-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.topicId === topicId);
            });
        }

        // Confirm add to topic
        async function confirmAddToTopic() {
            if (!selectedTopicId || !selectedSourceUrl) {
                showToast('S√©lectionnez un topic', 'warning');
                return;
            }

            try {
                // Get current topic
                const { data: topic, error: fetchError } = await supabaseClient
                    .from('topics')
                    .select('rss_feeds')
                    .eq('id', selectedTopicId)
                    .single();

                if (fetchError) throw fetchError;

                // Check if already added
                const currentFeeds = topic.rss_feeds || [];
                if (currentFeeds.includes(selectedSourceUrl)) {
                    showToast('Cette source est d√©j√† dans ce topic', 'warning');
                    closeModal();
                    return;
                }

                // Add source URL to feeds
                const { error: updateError } = await supabaseClient
                    .from('topics')
                    .update({ rss_feeds: [...currentFeeds, selectedSourceUrl] })
                    .eq('id', selectedTopicId);

                if (updateError) throw updateError;

                showToast('Source ajout√©e au topic', 'success');
                closeModal();
            } catch (error) {
                console.error('Error adding to topic:', error);
                showToast('Erreur lors de l\'ajout', 'error');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('addToTopicModal').classList.remove('visible');
            selectedSourceUrl = null;
            selectedTopicId = null;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentFilters.search = e.target.value;
                    renderSources();
                }, 300);
            });

            // Language filters
            document.querySelectorAll('.filter-btn[data-lang]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn[data-lang]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilters.lang = btn.dataset.lang;
                    renderSources();
                });
            });

            // Favorites filter
            document.getElementById('favoritesFilter').addEventListener('click', (e) => {
                e.target.classList.toggle('active');
                currentFilters.favorites = e.target.classList.contains('active');
                renderSources();
            });

            // Close modal on overlay click
            document.getElementById('addToTopicModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeModal();
                }
            });

            // Close modal on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        }
    </script>
</body>

</html>
